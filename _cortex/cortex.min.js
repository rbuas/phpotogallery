Cortex=function($,tracer,ClientData,Synapse){function Cortex(options){var _this=this;this.ready=!1,this.firstaccess=!0;var defaultOptions={version:"201603080830",defaultPage:"home",root:"",rootNote:"NOTES",skeletonPath:"/_skeleton",skinPath:"/mediaskin",memoryPath:"/_memory",contentExt:".html",dependencies:["ngRoute","ngSanitize","ngTouch"],module:"CortexModule",asyncMode:!0,Synapse:null,user:null,persistentData:[Cortex.DATA.USER]};this.options=$.extend({},defaultOptions,options),this.connections={};var _synapse=this.options.synapse||new Synapse({asyncMode:this.options.asyncMode});this.synapse=function(synapse,args){return synapse?_synapse[synapse]?_synapse[synapse].apply(_synapse,args):Promise.reject("Cortex::synapse: synapse not found."):Promise.reject("Cortex::synapse: missing params.")},this.waiting=function(){return _synapse.waiting},this.inconnection=function(){return this.inconnection},ClientData.call(this,this.options),startModule(this),browserext.injectClasses(),_this.updateData(Cortex.DATA.LANG,browserext.lang()||_this.options[Cortex.DATA.LANG]),_this.updateData(Cortex.DATA.USER,_this.options[Cortex.DATA.USER]||{}),_this.ready=!0}function isData(key){for(k in Cortex.DATA)if(Cortex.DATA[k]==key)return!0;return!1}function setRoot(instance,root){instance.root=root}function startModule(instance){instance&&(instance.module=angular.module(instance.options.module,instance.options.dependencies).run(function($rootScope,$location){setRoot(instance,$rootScope),$rootScope.$on("$locationChangeStart",function(event,next,current){lazyAction(function(){instance.access(next)})})}),instance.loadResource(Cortex.DATA.CONFIG,instance.options.config).then(function(){instance.loadResource(Cortex.DATA.COMMON,instance.options.common).then(function(){instance.loadResource(Cortex.DATA.MAP,instance.options.sitemap).then(function(response){lazyAction(function(){instance.access()})})})}))}return Cortex.DATA={USER:"user",LANG:"lang",SLUG:"slug",PARAMS:"params",ROUTE:"route",MAP:"map",CONFIG:"config",COMMON:"common",ERROR:"error",NOTE:"note",NOTELIST:"notelist",LIBRARY:"library",ALBUM:"album"},Cortex.prototype=$.extend({},ClientData.prototype,{broadcast:function(event){this.root&&this.ready&&(tracer.comm("Cortex::broadcast: ",event),this.root.$broadcast(event))},controller:function(controllerId,controller){return this.module.controller(controllerId,controller)},directive:function(directiveId,controller){return this.module.directive(directiveId,controller)},translate:function(token,forcelang){if(token){var lang=forcelang||this.get(Cortex.DATA.LANG)||"EN";if("object"==typeof token)return token[lang]||token[Object.keys(token)[0]];var common=this.get(Cortex.DATA.COMMON),obj=common?common[token]:null;return obj?obj[lang]:token}},config:function(key){var config=this.get(Cortex.DATA.CONFIG);return key&&config?config[key]:config},slugbase:function(slug){var slug=slug||"",map=this.get(Cortex.DATA.MAP);if(map){if(map[slug])return slug;for(r in map){var routeInfo=map[r];if(routeInfo&&routeInfo.ALIAS&&routeInfo.ALIAS.indexOf(slug)>=0)return r}}},catchError:function(response){if(!response||!response.status){var error="Missing response status.";return this.error(error),error}if("success"!=response.status){var error=response.error||response.status_message||"";return this.error("Response status error : "+error),error}},loadResource:function(key,filename){if(!filename)return Promise.resolve();var _this=this;return this.synapse("load",[filename]).then(function(data){return _this.updateData(key,data)},function error(error){return _this.error(error)})},update:function(tab){if(tab){var _this=this;for(key in tab)_this.updateData(key,tab[key])}},updateData:function(key,value){return isData(key)?(this.set(key,value),this.broadcast(key),value):void 0},error:function(error){return null==error?this.errors:(this.errors||(this.errors=[]),this.errors.push(error),this.broadcast(Cortex.DATA.ERROR),error)},skin:function(skin){var version=this.options.version?"?"+this.options.version:"";return this.options.root+this.options.skinPath+"/"+skin+version},skeleton:function(skeleton,ext){var ext=ext?ext:"html",version=this.options.version?"?"+this.options.version:"";if("string"==typeof skeleton)return this.options.root+this.options.skeletonPath+"/"+skeleton+"."+ext+version;var list={};for(key in skeleton){var file=skeleton[key];list[key]=this.options.root+this.options.skeletonPath+"/"+file+"."+ext+version}return list},route:function(slug){if(!slug)return this.get(Cortex.DATA.ROUTE);var map=this.get(Cortex.DATA.MAP);if(map){var route=map[slug];if(!route)for(r in map){var routeInfo=map[r];if(routeInfo&&routeInfo.ALIAS&&routeInfo.ALIAS.indexOf(slug)>=0){route=routeInfo;break}}return route}},routeAccess:function(slug){var route=this.route(slug);if(!route)return!1;if(!route.PRIVATE)return!0;var user=this.get(Cortex.DATA.USER);if(null==user)return!1;var config=this.get(Cortex.DATA.CONFIG),master=config?config.MASTER:null;return user.email==master?!0:this.userHasPassport(user,slug)},routeSkeleton:function(slug,ext){var skeleton,ext=ext?ext:"html",base=this.slugbase(slug),route=this.route(base);return route&&(route.SKELETON?skeleton=route.SKELETON:route.LIBRARY?skeleton=this.options.librarySkeleton:route.ALBUM&&(skeleton=this.options.albumSkeleton)),skeleton?this.skeleton(skeleton,ext):this.routeContent(base,ext)},routeContent:function(slug,ext){if(slug){var version=this.options.version?"?"+this.options.version:"",ext=ext?ext:"html",route=this.route(slug),content=slug,path=route&&route.PATH?route.PATH:this.options.memoryPath||"";route&&route.ALBUM&&(content=this.options.albumContent,path=this.options.albumsPath+"/"+route.ALBUM);var routecontent=this.options.root+path+"/"+content+"."+ext+version;return routecontent.replace("//","/")}},meta:function(property){if(property){if("SLUG"==property.toUpperCase())return this.data.slug;var route=this.route(),value=null!=route?route[property]:null;if(value)return value;var config=this.get(Cortex.DATA.CONFIG);return value=null!=config?config[property]:null}},pages:function(){var map=this.get(Cortex.DATA.MAP);if(map){var list={};for(slug in map){var page=map[slug];page&&!page.ALBUM&&(list[slug]=page)}return list}},catalog:function(filters,blacklist){var map=this.get(Cortex.DATA.MAP);if(map){var list={};for(slug in map)if(map.hasOwnProperty(slug)){var album=map[slug],isalbum=album&&album.ALBUM;if(isalbum){var haspassport=!album.PRIVATE||this.routeAccess(slug);if(haspassport){var inblacklist=ArrayMatchAny(blacklist,album.CATEGORY);if(!inblacklist){var inwhitelist=ArrayMatchAny(filters,album.CATEGORY);filters&&!inwhitelist||(list[slug]=album)}}}}return list}},param:function(key,value){var params=this.get(Cortex.DATA.PARAMS);return key?void 0===value?params?params[key]:null:(value?params[key]=value:delete params[key],void this.broadcast(Cortex.DATA.PARAMS)):params},paramMult:function(key,toggle){if(key){var param=this.param(key),values=param?param.split("|"):null;if(toggle){values=values||[];var index=values.indexOf(toggle);index>=0?values.splice(index,1):values.push(toggle),this.param(key,values.join("|"))}return values}},paramMultHas:function(key,value){if(!key)return!1;var values=this.paramMult(key);return!!(values&&values.indexOf(value)>=0)},getExplictParams:function(){var params=this.get(Cortex.DATA.PARAMS);if(!params)return"";var pick=ObjectPick(params,{black:["media","noteid"]}),explicit=Object.keys(pick).map(function(key){return""+key+"="+pick[key]}),params=explicit.join("&");return params?"?"+params:""},access:function(url){var _this=this;url=url||window.location.hash;var map=this.get(Cortex.DATA.MAP),slug=browserext.urlPath(),params=browserext.searchParams(),breadcrumb=browserext.breadcrumb(),base=breadcrumb&&breadcrumb.length>1?breadcrumb[0]:null;if(base)if(base==this.options.rootNote){var notesParam=breadcrumb.slice();slug=notesParam.shift(),params.noteid=notesParam.join("/")}else map&&map[base]&&(slug=base,params.media=breadcrumb[1]);return slug!=this.get(Cortex.DATA.SLUG)||this.firstaccess?this.connect(slug).then(function(response){_this.catchError(response)||(_this.updateData(Cortex.DATA.SLUG,slug||_this.options.defaultPage),_this.updateData(Cortex.DATA.PARAMS,params)),_this.broadcast(Cortex.DATA.ROUTE),_this.firstaccess=!1},function(error){_this.catchError({status:"error",error:"connection error"})}):void _this.updateData(Cortex.DATA.PARAMS,params)},connect:function(slug){this.errors=[];var _this=this;_this.inconnection=!0;var response=_this.getStoredConnection(slug);return response?Promise.resolve().then(function(){return lazyAction(function(){_this.updateData(Cortex.DATA.USER,response.user),_this.updateData(Cortex.DATA.ROUTE,response.route),_this.updateData(Cortex.DATA.LANG,response.lang),response.route&&response.route.ALBUMLINK&&_this.album(response.route.ALBUMLINK),_this.inconnection=!1}),response}):this.synapse("connect",[slug]).then(function(response){var error=_this.catchError(response);return error?error:(_this.storeConnection(slug,response),lazyAction(function(){_this.updateData(Cortex.DATA.USER,response.user),_this.updateData(Cortex.DATA.ROUTE,response.route),_this.updateData(Cortex.DATA.LANG,response.lang),response.route&&response.route.ALBUMLINK&&_this.album(response.route.ALBUMLINK),_this.inconnection=!1}),response)},function error(error){return _this.inconnection=!1,_this.error(error)})},storeConnection:function(slug,response){slug&&response&&(this.connections[slug]=response)},getStoredConnection:function(slug){return slug&&this.connections[slug]?this.connections[slug]:void 0},reset:function(){var _this=this;return this.synapse("reset").then(function(response){_this.catchError(response)||window.location.reload()},function error(error){return _this.error(error)})},cleanSite:function(){var _this=this;return this.synapse("cleanSite").then(function(response){_this.catchError(response)},function error(error){return _this.error(error)})},activeGuardian:function(text){var _this=this;return this.synapse("activeGuardian",[text]).then(function(response){_this.catchError(response)},function error(error){return _this.error(error)})},removeGuardian:function(){var _this=this;return this.synapse("removeGuardian").then(function(response){_this.catchError(response)},function error(error){return _this.error(error)})},lang:function(lang){var _this=this;return this.synapse("lang",[lang]).then(function(response){var error=_this.catchError(response);return error?error:void lazyAction(function(){_this.updateData(Cortex.DATA.LANG,response.lang)})},function error(error){return _this.error(error)})},login:function(email,password){var _this=this;return this.synapse("userLogin",[email,password]).then(function(response){var error=_this.catchError(response);return error?response:void lazyAction(function(){_this.updateData(Cortex.DATA.USER,response.user),_this.updateData(Cortex.DATA.LANG,response.user.lang)})},function error(error){return _this.error(error)})},logout:function(){var _this=this;return this.synapse("userLogout").then(function(response){var error=_this.catchError(response);return error?error:void lazyAction(function(){_this.updateData(Cortex.DATA.USER,response.user)})},function error(error){return _this.error(error)})},register:function(email,password,news,lang){var _this=this;return this.synapse("userCreate",[email,password,news,lang]).then(function(response){setTimeout(function(){_this.catchError(response)||_this.updateData(Cortex.DATA.USER,response.user)},0)},function error(error){return _this.error(error)})},confirm:function(email,token){var _this=this;return this.synapse("userConfirm",[email,token]).then(function(response){_this.catchError(response)||_this.updateData(Cortex.DATA.USER,response.user)},function error(error){return _this.error(error)})},retrievePassword:function(email){var _this=this;return this.synapse("userRetrievePassword",[email]).then(function(response){_this.catchError(response)||_this.updateData(Cortex.DATA.USER,response.user)},function error(error){return _this.error(error)})},user:function(){var _this=this;return this.synapse("userCurrent").then(function(response){_this.catchError(response)||_this.updateData(Cortex.DATA.USER,response.user)},function error(error){return _this.error(error)})},userAddFavorite:function(slug){var _this=this;return this.synapse("userAddFavorite",[slug]).then(function(response){_this.catchError(response)},function error(error){return _this.error(error)})},userRemoveFavorite:function(slug){var _this=this;return this.synapse("userRemoveFavorite",[slug]).then(function(response){_this.catchError(response)},function error(error){return _this.error(error)})},addPassport:function(email,slug){var _this=this;return this.synapse("userAddPassport",[email,slug]).then(function(response){_this.catchError(response)},function error(error){return _this.error(error)})},userRemovePassport:function(email,slug){var _this=this;return this.synapse("userRemovePassport",[email,slug]).then(function(response){_this.catchError(response)},function error(error){return _this.error(error)})},userHasPassport:function(user,slug){return user=user||this.user(),user&&user.passport?user.passport[slug]:!1}}),ClientData.prototype.constructor=ClientData,window.translate=Cortex.translate,Cortex}(jQuery,tracer,ClientData,Synapse,browserext);